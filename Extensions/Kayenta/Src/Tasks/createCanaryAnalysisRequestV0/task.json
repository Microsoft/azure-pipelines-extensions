{
  "id": "13a91ac7-d17e-4ca6-a4c0-723df247dd1b",
  "name": "createCanaryAnalysisRequest",
  "friendlyName": "Kayenta Canary Judge",
  "description": "Invokes Kayenta Judge For Automated Canary Analysis",
  "author": "Microsoft",
  "helpMarkDown": "",
  "category": "Utility",      
  "visibility": [
    "Release"
  ],
  "runsOn": [
    "ServerGate"
  ],
  "version": {
    "Major": 0,
    "Minor": 154,     
    "Patch": 2
  },
  "instanceNameFormat": "Kayenta Canary Judge",
  "groups": [
    {
      "name": "accountConfiguration",
      "displayName": "Account Configuration",
      "isExpanded": true
    },
    {
      "name": "thresholds",
      "displayName": "Thresholds",
      "isExpanded": true
    },
    {
    "name": "executionRequest",
    "displayName": "Analysis Configuration",
    "isExpanded": false
    },
    {
    "name": "scopes",
    "displayName": "Scopes",
    "isExpanded": false
    }
],
  "inputs": [
    {
        "name": "KayentaConnection",
        "type": "connectedService:kayenta",
        "label": "Kayenta connection",
        "defaultValue": "",
        "required": "true",
        "helpMarkDown": "Connection to the Kayenta instance used for canary analysis."
    },
    {
      "name": "metricsAccountName",
      "type": "string",       
      "label": "Metric account",
      "required": "true",
      "helpMarkDown": "Name of metric account configured for Kayenta Ex : datadog-account",
      "groupName": "accountConfiguration",
      "properties": {
          "EditableOptions": "True"
        }
    },
    {
      "name": "storageAccountName",
      "type": "string",       
      "label": "Storage account",
      "required": "true",
      "helpMarkDown": "Name of storage account configured for Kayenta Ex : google-account",
      "groupName": "accountConfiguration",
      "properties": {
          "EditableOptions": "True"
        }
    },
    {
      "name": "configAccountName",
      "type": "string",      
      "label": "Configuration Account",
      "required": "true",
      "helpMarkDown": "Configuration account name to fetch canary configurations. Ex : google-account",
      "groupName": "accountConfiguration",
      "properties": {
        "EditableOptions": "True"
        }
    },
    {
      "name": "canaryConfig",
      "type": "pickList",      
      "label": "Canary config",
      "required": "true",
      "helpMarkDown": "Choose the canary-config for the analysis.",
      "groupName": "accountConfiguration",
      "properties": {
        "EditableOptions": "False"
        }
    },
    {
        "name": "marginalThreshold",
        "type": "string",       
        "label": "Marginal threshold",
        "required": "false",
        "defaultValue": "0",
        "helpMarkDown": "Canary classification will return Marginal if canary-score falls above marginal threshold else return Fail, Ex : 75.0",
        "groupName": "thresholds",
        "properties": {
            "EditableOptions": "True"
          }
    },
    {
        "name": "passThreshold",
        "type": "string",      
        "label": "Pass threshold",
        "required": "true",
        "helpMarkDown": "Canary will Pass only if canary-score crosses pass threshold, Ex : 95.0",
        "groupName": "thresholds",
        "properties": {
            "EditableOptions": "True"
          }
    },
    {
        "name": "lifetimeDurationMins",
        "type": "string",      
        "label": "Analysis lifetime duration {mins}",
        "required": "true",
        "helpMarkDown": "Analysis lifetime will continue for this duration, Ex : 45",
        "groupName": "executionRequest",
        "properties": {
            "EditableOptions": "True"
          }
    },
    {
        "name": "lookbackMins",
        "type": "string",       
        "label": "Lookback {mins}",
        "defaultValue": "0",
        "required": "false",
        "helpMarkDown":"If this value is supplied, judgements will be performed on a sliding time window:endTime - lookbackMins to startTime + (judgementNumber * interval). If this field is omitted, the judgements will be performed on a growing time window:startTime + (judgementNumber - 1 * interval) to startTime + (judgementNumber * interval)", 
        "groupName": "executionRequest",
        "properties": {
            "EditableOptions": "True"
          }
    },
    {
        "name": "analysisIntervalMins",
        "type": "string",    
        "label": "Analysis interval {mins}",
        "required": "true",
        "helpMarkDown": "Judgement Analysis will occur after each interval during the lifetime of Analysis, Ex : 15",
        "groupName": "executionRequest",
        "properties": {
            "EditableOptions": "True"
          }
    },
    {
      "name": "experimentScope",
      "type": "string",       
      "label": "Canary scope",
      "required": "true",
      "helpMarkDown": "The label/dimension to create canary queries, Ex : myapp-canary-v001",
      "groupName": "scopes",
      "properties": {
          "EditableOptions": "True"
        }
    },
    {
      "name": "experimentLocation",
      "type": "string",       
      "label": "Canary location",
      "required": "false",
      "helpMarkDown": "To further differentiate based on server location, Ex : us-west-2",
      "groupName": "scopes",
      "properties": {
          "EditableOptions": "True"
        }
    },
    {
      "name": "controlScope",
      "type": "string",       
      "label": "Baseline scope",
      "required": "true",
      "helpMarkDown": "The label/dimension to create baseline queries, Ex : myapp-baseline-v001",
      "groupName": "scopes",
      "properties": {
          "EditableOptions": "True"
        }
    },
    {
      "name": "controlLocation",
      "type": "string",       
      "label": "Baseline location",
      "required": "false",
      "helpMarkDown": "To further differentiate based on server location, Ex : us-west-2",
      "groupName": "scopes",
      "properties": {
          "EditableOptions": "True"
        }
    },
    {
      "name": "scopeName",
      "type": "string",      
      "label": "Scope name",
      "required": "true",
      "defaultValue": "default",
      "helpMarkDown": "scope-name for canary-execution must be same as metric scope-name, Ex : default",
      "groupName": "scopes",
      "properties": {
          "EditableOptions": "True"
        }
  },
  {
    "name": "startTimeIso",
    "type": "string",      
    "label": "Execution Start-time ISO format",
    "required": "false",
    "helpMarkDown": "Example: 2018-12-17T21:56:39.689Z",
    "groupName": "scopes",
    "properties": {
        "EditableOptions": "True"
      }
  },
  {
    "name": "endTimeIso",
    "type": "string",      
    "label": "Execution End-time ISO format",
    "required": "false",
    "helpMarkDown": "Example: 2018-12-17T21:56:39.689Z",
    "groupName": "scopes",
    "properties": {
        "EditableOptions": "True"
      }
  },
  {
    "name": "step",
    "type": "string",      
    "label": "Step (seconds)",
    "defaultValue": "60",
    "required": "false",
    "helpMarkDown": "Kayenta will scrape data after each step in one Interval. Ex : 10",
    "groupName": "scopes",
    "properties": {
        "EditableOptions": "True"
      }
  },
  {
    "name": "extendedScopeParams",
    "type": "multiLine",      
    "label": "Extended scope parameters",
    "required": "false",
    "helpMarkDown": "Will introduce additional scope parameters",
    "groupName": "scopes",
    "properties": {
      "editorExtension": "ms.vss-services-azure.azure-servicebus-message-grid"
     }
  }
],
"dataSourceBindings": [{
  "target": "canaryConfig",
  "endpointId": "$(KayentaConnection)",
  "dataSourceName": "canaryConfig",
  "resultTemplate": "{ \"Value\" : \"{{id}}\", \"DisplayValue\" : \"{{name}}\" }",
  "parameters": {
    "configAccountName": "$(configAccountName)"
}
}
],
  "execution": {
    "HttpRequestChain": {
       "Execute": [
        {
          "RequestInputs": {
            "EndpointId": "$(KayentaConnection)",
            "EndpointUrl": "$(endpoint.url)standalone_canary_analysis/$(canaryConfig)?metricsAccountName=$(metricsAccountName)&configurationAccountName=$(configAccountName)&storageAccountName=$(storageAccountName)",
            "Method": "POST",
            "Body": "{\"analysisIntervalMins\":\"$(analysisIntervalMins)\",\"beginAfterMins\":\"$(release.deployment.gate.stabilizationTime)\",\"lifetimeDurationMins\":\"$(lifetimeDurationMins)\",\"lookbackMins\":\"$(lookbackMins)\",\"scopes\":[{\"controlLocation\":\"$(controlLocation)\",\"controlScope\":\"$(controlScope)\",{{#if endTimeIso}}\"endTimeIso\":\"$(endTimeIso)\",{{/if}}\"experimentLocation\":\"$(experimentLocation)\",\"experimentScope\":\"$(experimentScope)\",{{#if extendedScopeParams}}\"extendedScopeParams\":$(extendedScopeParams),{{/if}}\"scopeName\":\"$(scopeName)\",{{#if startTimeIso}}\"startTimeIso\":\"$(startTimeIso)\",{{/if}}\"step\":\"$(step)\"}],{{#if siteLocal}}\"siteLocal\":$(siteLocal),{{/if}}\"thresholds\":{\"marginal\":\"$(marginalThreshold)\",\"pass\":\"$(passThreshold)\"}}",
            "Headers": "{\"Content-Type\":\"application/json\", \"Accept\":\"application/json\"}",
            "WaitForCompletion": "false",
            "Expression": "eq(isNullOrEmpty(jsonpath('$.canaryAnalysisExecutionId')[0]),false)"
          },
          "ExecutionOptions": {
            "OutputVariables": "{\"canaryAnalysisExecutionId\":\"jsonpath('$.canaryAnalysisExecutionId')[0]\"}",
            "SkipSectionExpression": "eq(isNullOrEmpty(variables['canaryAnalysisExecutionId']),false)"
          }
        },
        {
          "RequestInputs": {
            "EndpointId": "$(KayentaConnection)",
            "EndpointUrl": "$(endpoint.url)standalone_canary_analysis/$(canaryAnalysisExecutionId)",
            "Method": "GET",
            "WaitForCompletion": "false",
            "Expression": "eq(eq(jsonpath('$.canaryAnalysisExecutionResult.canaryExecutionResults[0].result.judgeResult.score.classification')[0],'Pass'),true)"
          }
        }
       
      ]
    }
  }
}

    
